# SHCOPYRIGHT

SUBROOT=/usr/local/share/fsl_sub

#
# METHOD: Specify a batch mechanism. One of: NONE; SGE; HOSTLIST
#
METHOD=HOSTLIST

# METHOD-Specific options
#
# HOSTLIST: should have an entry for every machine you want to
# use. If a machine has multiple CPUs then add duplicates up to the
# number of jobs you want to service on that machine.
#
HOSTLIST="LOCAL"

# ---------- End of configuration options ---------
#
# Do NOT edit below this line
# unless you know exactly what you're doing.
#
NEXTHOST=1
NEXTJID=1
MAXJID=32767
LOCKFILE=${SUBROOT}/lock
SPOOLDIR=${SUBROOT}/spool

acquire_lock ()
{
    mkdir $LOCKFILE > /dev/null 2>&1
    if [ $? == 1 ] ; then
	return 0;
    else
	return 1;
    fi
}
 
release_lock ()
{
    rmdir $LOCKFILE
}

next_job ()
{
    acquire_lock
    while [ $? == 0 ] ; do
	sleep 2;
	acquire_lock
    done

    nhosts=`echo $HOSTLIST | awk '{print NF}'`
    index=`cat $RCFILE | grep "^NEXTHOST=" | awk -F '=' '{print $2}'`
    jid=`cat $RCFILE | grep "^NEXTJID=" | awk -F '=' '{print $2}'`
    host=`echo $HOSTLIST | awk '{print \$'$index'}'`
    next_index=`expr \( $index % $nhosts \) + 1`
    next_jid=`expr \( $jid % $MAXJID \) + 1`
    njid=`expr $jid + 100000 | sed s/^1//`
    cp $RCFILE /tmp/cfg
    cat <<EOF > /tmp/sedscript
s/^NEXTHOST=.*/NEXTHOST=${next_index}/
s/^NEXTJID=.*/NEXTJID=${next_jid}/
EOF
    sed -f /tmp/sedscript /tmp/cfg > $RCFILE
    rm /tmp/cfg /tmp/sedscript
    release_lock
}
